# ============================================================================
# Azure DevOps Pipeline - ATP Denmark dbt Project
# ============================================================================
# Trigger: On push to main branch
# Purpose: Run dbt models, tests, and deploy to Snowflake
# ============================================================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - models/**
      - dbt_project.yml
      - profiles.yml
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
  paths:
    include:
      - models/**
      - dbt_project.yml

variables:
  - group: snowflake-credentials  # Variable group with secrets
  - name: DBT_PROFILES_DIR
    value: $(Build.SourcesDirectory)

pool:
  vmImage: 'ubuntu-latest'

stages:
  # ============================================================================
  # STAGE 1: Build & Test
  # ============================================================================
  - stage: Build
    displayName: 'Build and Test dbt Models'
    jobs:
      - job: dbt_build
        displayName: 'dbt Build'
        steps:
          # Step 1: Checkout code
          - checkout: self
            displayName: 'Checkout Repository'
            clean: true

          # Step 2: Install Python
          - task: UsePythonVersion@0
            displayName: 'Use Python 3.10'
            inputs:
              versionSpec: '3.10'
              addToPath: true

          # Step 3: Install dbt and dependencies
          - script: |
              python -m pip install --upgrade pip
              pip install dbt-core==1.7.0 dbt-snowflake==1.7.0
            displayName: 'Install dbt'

          # Step 4: Verify dbt installation
          - script: |
              dbt --version
            displayName: 'Verify dbt Installation'

          # Step 5: dbt Debug (test connection)
          - script: |
              dbt debug --profiles-dir $(DBT_PROFILES_DIR)
            displayName: 'dbt Debug (Test Connection)'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          # Step 6: dbt Deps (install packages)
          - script: |
              dbt deps --profiles-dir $(DBT_PROFILES_DIR)
            displayName: 'dbt Deps (Install Packages)'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          # Step 7: dbt Run (build models)
          - script: |
              dbt run --profiles-dir $(DBT_PROFILES_DIR) --target dev
            displayName: 'dbt Run (Build Models)'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          # Step 8: dbt Test (run data quality tests)
          - script: |
              dbt test --profiles-dir $(DBT_PROFILES_DIR) --target dev
            displayName: 'dbt Test (Run Data Quality Tests)'
            continueOnError: true  # Don't fail build on test failures
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          # Step 9: dbt Docs Generate
          - script: |
              dbt docs generate --profiles-dir $(DBT_PROFILES_DIR) --target dev
            displayName: 'dbt Docs Generate'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          # Step 10: Publish dbt artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'Publish dbt Artifacts'
            inputs:
              PathtoPublish: 'target'
              ArtifactName: 'dbt-artifacts'
              publishLocation: 'Container'

          # Step 11: Publish test results
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'target/run_results.json'
              failTaskOnFailedTests: false

  # ============================================================================
  # STAGE 2: Deploy to Production
  # ============================================================================
  - stage: Deploy_Production
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: deploy_prod
        displayName: 'Deploy to Snowflake Production'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Step 1: Download artifacts
                - download: current
                  artifact: dbt-artifacts

                # Step 2: Install dbt
                - task: UsePythonVersion@0
                  displayName: 'Use Python 3.10'
                  inputs:
                    versionSpec: '3.10'

                - script: |
                    pip install dbt-core==1.7.0 dbt-snowflake==1.7.0
                  displayName: 'Install dbt'

                # Step 3: Deploy to production
                - script: |
                    dbt run --profiles-dir $(DBT_PROFILES_DIR) --target prod
                  displayName: 'dbt Run (Production)'
                  env:
                    SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
                    SNOWFLAKE_USER: $(SNOWFLAKE_USER_PROD)
                    SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD_PROD)

                # Step 4: Run production tests
                - script: |
                    dbt test --profiles-dir $(DBT_PROFILES_DIR) --target prod
                  displayName: 'dbt Test (Production)'
                  env:
                    SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
                    SNOWFLAKE_USER: $(SNOWFLAKE_USER_PROD)
                    SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD_PROD)

