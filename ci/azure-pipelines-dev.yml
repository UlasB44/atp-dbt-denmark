# ============================================================================
# Azure DevOps Pipeline - DEV Environment
# ============================================================================
# Purpose: Development environment for testing dbt changes
# Trigger: Manual or on feature branches
# ============================================================================

trigger: none  # Manual trigger only

pr: none

variables:
  - group: snowflake-credentials-dev
  - name: DBT_PROFILES_DIR
    value: $(Build.SourcesDirectory)
  - name: DBT_TARGET
    value: dev

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Dev_Deploy
    displayName: 'Deploy to DEV'
    jobs:
      - job: dbt_dev
        displayName: 'dbt Run (DEV)'
        steps:
          - checkout: self

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.10'

          - script: |
              pip install dbt-core==1.7.0 dbt-snowflake==1.7.0
            displayName: 'Install dbt'

          - script: |
              dbt debug --profiles-dir $(DBT_PROFILES_DIR) --target $(DBT_TARGET)
            displayName: 'dbt Debug'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          - script: |
              dbt run --profiles-dir $(DBT_PROFILES_DIR) --target $(DBT_TARGET)
            displayName: 'dbt Run'
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

          - script: |
              dbt test --profiles-dir $(DBT_PROFILES_DIR) --target $(DBT_TARGET)
            displayName: 'dbt Test'
            continueOnError: true
            env:
              SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
              SNOWFLAKE_USER: $(SNOWFLAKE_USER)
              SNOWFLAKE_PASSWORD: $(SNOWFLAKE_PASSWORD)

